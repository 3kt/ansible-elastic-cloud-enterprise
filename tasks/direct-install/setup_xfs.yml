---
- name: Make sure /mnt/data exists
  become: yes
  file:
    path: /mnt/data
    state: directory

- name: Create the volume
  become: yes
  lvg:
    vg: lxc
    pvs: /dev/{{ device_name }}
    force: true

- name: Define size of swap
  become: yes
  shell: SWAP_MAX_SIZE=$(sudo vgdisplay --units M lxc | grep "VG Size" | awk '{ print mem=int(0.07*$3) }'); grep MemTotal /proc/meminfo | awk -v MAXMEM=${SWAP_MAX_SIZE} '{ mem=int($2/(2*1024)); if(mem>MAXMEM) mem=MAXMEM; print mem; }'
  register: swap_size

- name: Create swap volume
  become: yes
  lvol:
    vg: lxc
    lv: swap
    size: "{{swap_size.stdout}}m"
    force: true

- name: Create data volume
  become: yes
  lvol:
    vg: lxc
    lv: data
    size: 100%FREE
    force: true

- name: Setup swap
  become: yes
  command: mkswap /dev/lxc/swap

- name: Create xfs filesystem on /dev/lxc/data
  become: yes
  filesystem:
    fstype: xfs
    dev: /dev/lxc/data

- name: Mount /dev/lxc/data
  become: yes
  mount:
    path: /mnt/data
    state: mounted
    src: /dev/lxc/data
    fstype: xfs
    opts: "defaults,pquota,prjquota,x-systemd.automount"

- name: Mount /dev/lxc/swap
  become: yes
  mount:
    src: "/dev/lxc/swap"
    name: "swap"
    fstype: "swap"
    opts: "swap"
    dump: "0"
    passno: "0"
    state: "present"

- name: Enable all swap devices
  become: yes
  command: swapon -a
  args:
    warn: no
